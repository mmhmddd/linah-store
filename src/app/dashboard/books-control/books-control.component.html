<div class="books-control-container">
  <app-sidebar></app-sidebar>

  <main class="books-main">
    <header class="books-header">
      <div class="header-content">
        <div class="header-text">
          <h1 class="header-title">ุฅุฏุงุฑุฉ ุงููุชุจ</h1>
          <p class="header-subtitle">ุฅุถุงูุฉุ ุชุนุฏููุ ูุญุฐู ุงููุชุจ ูุฅุฏุงุฑุฉ ุงูุนุฑูุถ ูุงููุฎุฒูู</p>
        </div>
        <button class="add-book-btn" (click)="openAddBookForm()" *ngIf="!showForm">
          <span class="btn-icon">+</span>
          <span>ุฅุถุงูุฉ ูุชุงุจ ุฌุฏูุฏ</span>
        </button>
      </div>
    </header>

    <div class="alert error" *ngIf="errorMessage">
      <div class="alert-content">
        <span class="alert-icon">โ</span>
        <span class="alert-text">{{ errorMessage }}</span>
      </div>
      <button class="close-alert" (click)="errorMessage = null">โ</button>
    </div>

    <div class="loading-overlay" *ngIf="isLoading">
      <div class="loading-content">
        <div class="spinner"></div>
        <span>ุฌุงุฑู ุงูุชุญููู...</span>
      </div>
    </div>

    <div class="form-container" *ngIf="showForm">
      <div class="form-header">
        <h2>{{ editingBookId ? 'ุชุนุฏูู ุงููุชุงุจ' : 'ุฅุถุงูุฉ ูุชุงุจ ุฌุฏูุฏ' }}</h2>
        <button class="close-form-btn" (click)="cancelForm()">โ</button>
      </div>

      <form [formGroup]="bookForm" (ngSubmit)="submitBook()">
        <div class="form-section">
          <h3 class="section-title">ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="name">ุงุณู ุงููุชุงุจ <span class="required">*</span></label>
              <input
                id="name"
                formControlName="name"
                type="text"
                placeholder="ุฃุฏุฎู ุงุณู ุงููุชุงุจ"
                [class.error]="bookForm.get('name')?.touched && bookForm.get('name')?.invalid" />
              <div class="error-message" *ngIf="bookForm.get('name')?.touched && bookForm.get('name')?.invalid">
                ุงุณู ุงููุชุงุจ ูุทููุจ
              </div>
            </div>

            <div class="form-group">
              <label for="title">ุงูุนููุงู <span class="required">*</span></label>
              <input
                id="title"
                formControlName="title"
                type="text"
                placeholder="ุฃุฏุฎู ุนููุงู ุงููุชุงุจ"
                [class.error]="bookForm.get('title')?.touched && bookForm.get('title')?.invalid" />
              <div class="error-message" *ngIf="bookForm.get('title')?.touched && bookForm.get('title')?.invalid">
                ุงูุนููุงู ูุทููุจ
              </div>
            </div>

            <div class="form-group">
              <label for="category">ุงููุฆุฉ <span class="required">*</span></label>
              <input
                id="category"
                formControlName="category"
                type="text"
                placeholder="ุฃุฏุฎู ุงููุฆุฉ"
                [class.error]="bookForm.get('category')?.touched && bookForm.get('category')?.invalid" />
              <div class="error-message" *ngIf="bookForm.get('category')?.touched && bookForm.get('category')?.invalid">
                ุงููุฆุฉ ูุทููุจุฉ
              </div>
            </div>

            <div class="form-group">
              <label for="code">ุฑูุฒ ุงููุชุงุจ</label>
              <input id="code" formControlName="code" type="text" placeholder="ุฃุฏุฎู ุฑูุฒ ุงููุชุงุจ" />
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-title">ุงูุชุณุนูุฑ ูุงููุฎุฒูู</h3>
          <div class="form-grid pricing-grid">
            <div class="form-group">
              <label for="price">ุงูุณุนุฑ (ุฌููู) <span class="required">*</span></label>
              <input
                id="price"
                formControlName="price"
                type="number"
                placeholder="0.00"
                [class.error]="bookForm.get('price')?.touched && bookForm.get('price')?.invalid" />
              <div class="error-message" *ngIf="bookForm.get('price')?.touched && bookForm.get('price')?.invalid">
                ุงูุณุนุฑ ูุฌุจ ุฃู ูููู ุฑูููุง ููุฌุจูุง
              </div>
            </div>

            <div class="form-group">
              <label for="quantity">ุงููููุฉ <span class="required">*</span></label>
              <input
                id="quantity"
                formControlName="quantity"
                type="number"
                placeholder="0"
                [class.error]="bookForm.get('quantity')?.touched && bookForm.get('quantity')?.invalid" />
              <div class="error-message" *ngIf="bookForm.get('quantity')?.touched && bookForm.get('quantity')?.invalid">
                ุงููููุฉ ูุฌุจ ุฃู ุชููู ุฑูููุง ููุฌุจูุง
              </div>
            </div>

            <div class="form-group">
              <label for="offer">ูุณุจุฉ ุงูุฎุตู (%)</label>
              <input
                id="offer"
                formControlName="offer"
                type="number"
                placeholder="0"
                [class.error]="bookForm.get('offer')?.touched && bookForm.get('offer')?.invalid" />
              <div class="error-message" *ngIf="bookForm.get('offer')?.touched && bookForm.get('offer')?.invalid">
                ูุณุจุฉ ุงูุฎุตู ูุฌุจ ุฃู ุชููู ุจูู 0 ู100
              </div>
            </div>

            <div class="form-group price-preview" *ngIf="bookForm.get('price')?.value > 0">
              <label>ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู</label>
              <div class="price-display">
                <span class="final-price">{{ calculateFinalPrice() | number:'1.2-2' }} ุฌููู</span>
                <span class="original-price" *ngIf="bookForm.get('offer')?.value > 0">{{ bookForm.get('price')?.value | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-title">ุงููุตู</h3>
          <div class="form-group full-width">
            <label for="description">ูุตู ุงููุชุงุจ</label>
            <textarea
              id="description"
              formControlName="description"
              placeholder="ุฃุฏุฎู ูุตููุง ุชูุตููููุง ูููุชุงุจ..."
              rows="4"></textarea>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-title">ุตูุฑ ุงููุชุงุจ</h3>
          <div class="form-group full-width">
            <div class="file-upload-area">
              <input
                id="imgs"
                type="file"
                multiple
                accept="image/jpeg,image/png,image/gif,image/webp"
                (change)="onFileChange($event)"
                #fileInput />
              <label for="imgs" class="file-upload-label">
                <span class="upload-icon">๐ท</span>
                <span class="upload-text">ุงุถุบุท ูุงุฎุชูุงุฑ ุงูุตูุฑ</span>
                <span class="upload-hint">ุญุฏ ุฃูุตู 5 ุตูุฑ (JPEG, PNG, GIF, WebP)</span>
              </label>
            </div>

            <div class="image-preview-grid" *ngIf="selectedFiles.length > 0">
              <div *ngFor="let file of selectedFiles; let i = index" class="preview-card">
                <img [src]="file.preview" alt="Preview" class="preview-img" />
                <button type="button" class="remove-img" (click)="removeImage(i)">
                  <span>โ</span>
                </button>
                <div class="image-overlay">
                  <span class="image-number">{{ i + 1 }}</span>
                </div>
              </div>
            </div>

            <div class="error-message" *ngIf="imageError">{{ imageError }}</div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" [disabled]="isSubmitDisabled()">
            <span>{{ editingBookId ? 'ุชุญุฏูุซ ุงููุชุงุจ' : 'ุญูุธ ุงููุชุงุจ' }}</span>
          </button>
          <button type="button" class="btn-secondary" (click)="cancelForm()">ุฅูุบุงุก</button>
        </div>
      </form>
    </div>

    <div class="books-list-section" *ngIf="!showForm">
      <div class="section-header">
        <h2 class="section-title-main">ูุงุฆูุฉ ุงููุชุจ</h2>
        <div class="books-count">
          <span class="count-number">{{ filteredBooks.length }}</span>
          <span class="count-text">ูุชุงุจ</span>
        </div>
      </div>

      <div class="filters-bar">
        <div class="filter-item">
          <label for="categoryFilter">ุงููุฆุฉ</label>
          <select id="categoryFilter" [(ngModel)]="categoryFilter" (change)="filterBooks()">
            <option value="">ุฌููุน ุงููุฆุงุช</option>
            <option *ngFor="let category of uniqueCategories" [value]="category">{{ category }}</option>
          </select>
        </div>

        <div class="filter-item">
          <label for="stockFilter">ุงููุฎุฒูู</label>
          <select id="stockFilter" [(ngModel)]="stockFilter" (change)="filterBooks()">
            <option value="">ุงููู</option>
            <option value="inStock">ูุชููุฑ</option>
            <option value="outOfStock">ุบูุฑ ูุชููุฑ</option>
          </select>
        </div>

        <div class="filter-item">
          <label for="sortBy">ุชุฑุชูุจ ุญุณุจ</label>
          <select id="sortBy" [(ngModel)]="sortBy" (change)="sortBooks()">
            <option value="name">ุงูุงุณู</option>
            <option value="price">ุงูุณุนุฑ</option>
            <option value="quantity">ุงููููุฉ</option>
          </select>
        </div>
      </div>

      <div class="books-grid">
        <div *ngFor="let book of filteredBooks" class="book-card">
          <div class="book-image-container">
            <div class="image-wrapper">
              <img
                [src]="getImageUrl(book.imgs[0])"
                [alt]="book.name"
                class="book-image"
                (error)="handleImageError(-1, book._id)"
                loading="lazy" />
              <div class="stock-badge" [class.out-of-stock]="book.stockStatus === 'outOfStock'">
                {{ book.stockStatus === 'inStock' ? 'ูุชููุฑ' : 'ุบูุฑ ูุชููุฑ' }}
              </div>
              <div class="offer-badge" *ngIf="book.offer > 0">
                ุฎุตู {{ book.offer }}%
              </div>
            </div>
            <div class="image-thumbnails-small" *ngIf="book.imgs.length > 1">
              <div
                *ngFor="let img of book.imgs.slice(0, 4); let i = index"
                class="thumbnail-small"
                (click)="openImageModal(img)">
                <img [src]="getImageUrl(img)" [alt]="book.name" />
              </div>
              <div class="more-images" *ngIf="book.imgs.length > 4" (click)="openImageModal(book.imgs[0])">
                +{{ book.imgs.length - 4 }}
              </div>
            </div>
          </div>

          <div class="book-content">
            <h3 class="book-name">{{ book.name }}</h3>
            <p class="book-title">{{ book.title }}</p>
            <div class="book-category">{{ book.category }}</div>

            <div class="book-details">
              <div class="detail-item">
                <span class="detail-label">ุงูููุฏ:</span>
                <span class="detail-value">{{ book.code || 'ุบูุฑ ูุญุฏุฏ' }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ุงููููุฉ:</span>
                <span class="detail-value">{{ book.quantity }}</span>
              </div>
            </div>

            <div class="book-price">
              <div class="price-main">
                <span class="current-price">{{ calculateBookFinalPrice(book) | number:'1.2-2' }}</span>
                <span class="currency">ุฌููู</span>
              </div>
              <div class="price-original" *ngIf="book.offer > 0">
                <span class="original-amount">{{ book.price | number:'1.2-2' }}</span>
              </div>
            </div>

            <div class="book-description" *ngIf="book.description">
              {{ book.description | slice:0:100 }}{{ book.description.length > 100 ? '...' : '' }}
            </div>
          </div>

          <div class="book-actions">
            <button class="action-btn edit" (click)="editBook(book)">
              <span class="action-icon">โ๏ธ</span>
              <span>ุชุนุฏูู</span>
            </button>
            <button class="action-btn delete" (click)="openDeleteModal(book._id!)">
              <span class="action-icon">๐๏ธ</span>
              <span>ุญุฐู</span>
            </button>
            <button class="action-btn offer" (click)="openOfferModal(book._id!, book.offer)">
              <span class="action-icon">๐ท๏ธ</span>
              <span>ุฎุตู</span>
            </button>
            <button class="action-btn stock" (click)="openStockModal(book._id!, book.quantity)">
              <span class="action-icon">๐ฆ</span>
              <span>ูุฎุฒูู</span>
            </button>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="filteredBooks.length === 0">
        <div class="empty-icon">๐</div>
        <h3>ูุง ุชูุฌุฏ ูุชุจ</h3>
        <p>ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ูุชุจ. ุฌุฑุจ ุชุบููุฑ ุงูููุงุชุฑ ุฃู ุฃุถู ูุชุงุจุงู ุฌุฏูุฏุงู.</p>
      </div>
    </div>
  </main>

  <div class="modal" *ngIf="imageModalUrls && imageModalUrls.length > 0" (click)="imageModalUrls = null">
    <div class="modal-content large" (click)="$event.stopPropagation()">
      <button class="close-modal" (click)="imageModalUrls = null">โ</button>
      <div class="carousel">
        <img [src]="getImageUrl(imageModalUrls[currentImageIndex])" alt="Full-size Image" class="modal-image" />
        <button class="carousel-btn prev" *ngIf="imageModalUrls.length > 1" (click)="prevImage()">โฎ</button>
        <button class="carousel-btn next" *ngIf="imageModalUrls.length > 1" (click)="nextImage()">โฏ</button>
        <div class="carousel-indicators" *ngIf="imageModalUrls.length > 1">
          <span
            *ngFor="let img of imageModalUrls; let i = index"
            [class.active]="i === currentImageIndex"
            (click)="currentImageIndex = i"></span>
        </div>
        <div class="image-counter">{{ currentImageIndex + 1 }} / {{ imageModalUrls.length }}</div>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="deleteModalId" (click)="deleteModalId = null">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-icon delete-icon">๐๏ธ</div>
      <h2>ุชุฃููุฏ ุงูุญุฐู</h2>
      <p>ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุชุงุจุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
      <div class="modal-actions">
        <button class="modal-btn danger" (click)="confirmDelete()">ุญุฐู</button>
        <button class="modal-btn cancel" (click)="deleteModalId = null">ุฅูุบุงุก</button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="offerModalId" (click)="offerModalId = null">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-icon offer-icon">๐ท๏ธ</div>
      <h2>ุฅุถุงูุฉ ุฎุตู</h2>
      <div class="form-group">
        <label for="offerInput">ูุณุจุฉ ุงูุฎุตู (%)</label>
        <input
          id="offerInput"
          type="number"
          [(ngModel)]="offerModalValue"
          min="0"
          max="100"
          placeholder="ุฃุฏุฎู ูุณุจุฉ ุงูุฎุตู" />
        <div class="error-message" *ngIf="offerModalValue < 0 || offerModalValue > 100">
          ูุณุจุฉ ุงูุฎุตู ูุฌุจ ุฃู ุชููู ุจูู 0 ู100
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn confirm" [disabled]="offerModalValue < 0 || offerModalValue > 100" (click)="confirmOffer()">ุญูุธ</button>
        <button class="modal-btn cancel" (click)="offerModalId = null">ุฅูุบุงุก</button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="stockModalId" (click)="stockModalId = null">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-icon stock-icon">๐ฆ</div>
      <h2>ุชุญุฏูุซ ุงููุฎุฒูู</h2>
      <div class="form-group">
        <label for="stockInput">ุงููููุฉ ุงููุชููุฑุฉ</label>
        <input
          id="stockInput"
          type="number"
          [(ngModel)]="stockModalValue"
          min="0"
          placeholder="ุฃุฏุฎู ุงููููุฉ" />
        <div class="error-message" *ngIf="stockModalValue < 0">
          ุงููููุฉ ูุฌุจ ุฃู ุชููู 0 ุฃู ุฃูุซุฑ
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn confirm" [disabled]="stockModalValue < 0" (click)="confirmStock()">ุญูุธ</button>
        <button class="modal-btn cancel" (click)="stockModalId = null">ุฅูุบุงุก</button>
      </div>
    </div>
  </div>
</div>
