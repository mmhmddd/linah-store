<!-- src/app/features/children-stories/children-stories.component.html -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="children-books-container" dir="rtl" lang="ar">
  <main class="books-main">
    <!-- Toast Container -->
    <div class="toast-container">
      <div *ngFor="let toast of toasts; trackBy: trackByToastId" class="toast toast-{{toast.type}}">
        <div class="toast-content">
          <span class="toast-icon">
            {{ toast.type === 'success' ? 'Check' : toast.type === 'error' ? 'Cross' : 'Info' }}
          </span>
          <span class="toast-message">{{toast.message}}</span>
        </div>
        <button class="toast-close" (click)="removeToast(toast.id)">×</button>
      </div>
    </div>

    <!-- Books List Section -->
    <div class="books-list-section">
      <div class="section-header">
        <h2 class="section-title-main">قصص الأطفال</h2>
        <div class="books-count">
          <span class="count-number">{{ filteredBooks.length }}</span>
          <span class="count-text">قصة</span>
        </div>
        <button class="sidebar-toggle" (click)="toggleSidebar()" aria-label="فتح فلاتر التصفية">
          <i class="fas fa-filter"></i>
          <span class="toggle-text">تصفية</span>
        </button>
      </div>

      <!-- Desktop Filters (NO CATEGORY) -->
      <div class="filters-bar desktop-filters">
        <div class="filter-item">
          <label for="search">بحث</label>
          <input id="search" type="text" [(ngModel)]="searchTerm" (input)="filterBooks()" placeholder="ابحث عن قصة...">
        </div>
        <div class="filter-item">
          <label for="stockFilter">المخزون</label>
          <select id="stockFilter" [(ngModel)]="stockFilter" (change)="filterBooks()">
            <option value="">الكل</option>
            <option value="inStock">متوفر</option>
            <option value="outOfStock">غير متوفر</option>
          </select>
        </div>
        <div class="filter-item">
          <label for="sortBy">ترتيب حسب</label>
          <select id="sortBy" [(ngModel)]="sortBy" (change)="sortBooks()">
            <option value="name">الاسم</option>
            <option value="price">السعر</option>
            <option value="quantity">الكمية</option>
          </select>
        </div>
      </div>

      <!-- Mobile Sidebar (NO CATEGORY) -->
      <div class="sidebar" [class.open]="isSidebarOpen">
        <div class="sidebar-content" (click)="$event.stopPropagation()">
          <button class="sidebar-close" (click)="toggleSidebar()">×</button>
          <div class="filters-bar">
            <div class="filter-item">
              <label for="search-mobile">بحث</label>
              <input id="search-mobile" type="text" [(ngModel)]="searchTerm" (input)="filterBooks()" placeholder="ابحث...">
            </div>
            <div class="filter-item">
              <label for="stockFilter-mobile">المخزون</label>
              <select id="stockFilter-mobile" [(ngModel)]="stockFilter" (change)="filterBooks()">
                <option value="">الكل</option>
                <option value="inStock">متوفر</option>
                <option value="outOfStock">غير متوفر</option>
              </select>
            </div>
            <div class="filter-item">
              <label for="sortBy-mobile">ترتيب حسب</label>
              <select id="sortBy-mobile" [(ngModel)]="sortBy" (change)="sortBooks()">
                <option value="name">الاسم</option>
                <option value="price">السعر</option>
                <option value="quantity">الكمية</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Books Grid -->
      <div class="books-grid">
        <div *ngFor="let book of filteredBooks; trackBy: trackByBookId" class="book-card">
          <div class="book-image-container">
            <div class="image-wrapper">
              <img [src]="getImageUrl(book.imgs[0])" [alt]="book.name" class="book-image" (error)="handleImageError(book._id)" loading="lazy" />
              <div class="stock-badge" [class.out-of-stock]="book.stockStatus === 'outOfStock'">
                {{ book.stockStatus === 'inStock' ? 'متوفر' : 'غير متوفر' }}
              </div>
              <div class="offer-badge" *ngIf="hasDiscount(book)">خصم {{ book.offer }}%</div>
            </div>
            <div class="image-thumbnails-small" *ngIf="book.imgs.length > 1">
              <div *ngFor="let img of book.imgs.slice(0, 4); let i = index" class="thumbnail-small" (click)="openImageModal(img)">
                <img [src]="getImageUrl(img)" [alt]="book.name" />
              </div>
              <div class="more-images" *ngIf="book.imgs.length > 4" (click)="openImageModal(book.imgs[0])">+{{ book.imgs.length - 4 }}</div>
            </div>
          </div>

          <div class="book-content">
            <div class="book-info">
              <h3 class="book-name">{{ book.name }}</h3>
              <p class="book-title">{{ book.title }}</p>
              <div class="book-category">  {{ (book.category) }}</div>

              <div class="book-details">
                <div class="detail-item"><span class="detail-label">الكود:</span><span class="detail-value">{{ book.code || 'غير محدد' }}</span></div>
                <div class="detail-item"><span class="detail-label">الكمية:</span><span class="detail-value">{{ book.quantity }}</span></div>
              </div>

              <div class="book-price">
                <div class="price-main">
                  <span class="current-price">{{ calculateBookFinalPrice(book) | number:'1.2-2' }}</span>
                  <span class="currency">جنيه</span>
                </div>
                <div class="price-original" *ngIf="hasDiscount(book)">
                  <span class="original-amount">{{ book.price | number:'1.2-2' }}</span>
                </div>
              </div>
            </div>

            <div class="book-actions">
              <button class="action-btn cart-btn" [class.remove-btn]="isInCart(book)" (click)="isInCart(book) ? removeFromCart(book) : addToCart(book)" [disabled]="book.stockStatus === 'outOfStock'">
                <i class="fas fa-shopping-cart"></i>
                <span class="btn-text">{{ isInCart(book) ? 'إزالة' : 'إضافة' }}</span>
              </button>
              <button class="action-btn fav-btn" (click)="toggleFavorite(book)" [class.active]="isBookFavorited(book)">
                <i class="fas" [class.fa-heart]="isBookFavorited(book)" [class.fa-heart-o]="!isBookFavorited(book)"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredBooks.length === 0">
        <div class="empty-icon">كتاب</div>
        <h3>لا توجد قصص أطفال</h3>
        <p>جرب البحث أو تحقق من المخزون.</p>
      </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" *ngIf="imageModalUrls && imageModalUrls.length > 0" (click)="closeImageModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <button class="close-modal" (click)="closeImageModal()">×</button>
        <div class="carousel">
          <img [src]="getImageUrl(imageModalUrls[currentImageIndex])" alt="صورة كبيرة" class="modal-image" />
          <button class="carousel-btn prev" *ngIf="imageModalUrls.length > 1" (click)="prevImage(); $event.stopPropagation()">Previous</button>
          <button class="carousel-btn next" *ngIf="imageModalUrls.length > 1" (click)="nextImage(); $event.stopPropagation()">Next</button>
          <div class="carousel-indicators" *ngIf="imageModalUrls.length > 1">
            <span *ngFor="let img of imageModalUrls; let i = index" [class.active]="i === currentImageIndex" (click)="currentImageIndex = i; $event.stopPropagation()"></span>
          </div>
          <div class="image-counter">{{ currentImageIndex + 1 }} / {{ imageModalUrls.length }}</div>
        </div>
      </div>
    </div>
  </main>
</div>
